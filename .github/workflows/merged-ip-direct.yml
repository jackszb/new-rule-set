name: Update merged-ip-direct Rules

on:
  schedule:
    - cron: '0 3 * * 1'   # 每周一 03:00（UTC）
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install sing-box
        run: |
          set -e
          curl -fsSL https://sing-box.app/install.sh | sh
          sing-box version

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install netaddr

      - name: Download rule sources
        run: |
          set -e
          mkdir -p sources

          curl -fsSL \
            https://raw.githubusercontent.com/Dreista/sing-box-rule-set-cn/rule-set/apnic-cn-ipv4.json \
            -o sources/apnic-ipv4.json

          curl -fsSL \
            https://raw.githubusercontent.com/Dreista/sing-box-rule-set-cn/rule-set/apnic-cn-ipv6.json \
            -o sources/apnic-ipv6.json

          curl -fsSL \
            https://raw.githubusercontent.com/Dreista/sing-box-rule-set-cn/rule-set/maxmind-cn-ipv4.json \
            -o sources/maxmind-ipv4.json

          curl -fsSL \
            https://raw.githubusercontent.com/Dreista/sing-box-rule-set-cn/rule-set/maxmind-cn-ipv6.json \
            -o sources/maxmind-ipv6.json

          curl -fsSL \
            https://raw.githubusercontent.com/jackszb/rules-build/main/rules-src/geoip-private.json \
            -o sources/private.json

      - name: Merge CIDRs and generate merged-ip-direct.json
        run: |
          python << 'EOF'
          import json
          import os
          from netaddr import IPNetwork, cidr_merge

          source_files = [
              "sources/apnic-ipv4.json",
              "sources/apnic-ipv6.json",
              "sources/maxmind-ipv4.json",
              "sources/maxmind-ipv6.json",
              "sources/private.json",
          ]

          ipv4 = []
          ipv6 = []

          for path in source_files:
              with open(path, "r") as f:
                  data = json.load(f)

              for rule in data.get("rules", []):
                  for cidr in rule.get("ip_cidr", []):
                      net = IPNetwork(cidr)
                      if net.version == 4:
                          ipv4.append(net)
                      else:
                          ipv6.append(net)

          ipv4_merged = cidr_merge(ipv4)
          ipv6_merged = cidr_merge(ipv6)

          all_cidrs = [str(n) for n in ipv4_merged + ipv6_merged]

          os.makedirs("rule-set", exist_ok=True)

          out = {
              "version": 3,
              "rules": [
                  {
                      "ip_cidr": all_cidrs
                  }
              ]
          }

          with open("rule-set/merged-ip-direct.json", "w") as f:
              json.dump(out, f, indent=2)

          print(f"IPv4 CIDRs: {len(ipv4_merged)}")
          print(f"IPv6 CIDRs: {len(ipv6_merged)}")
          print(f"Total CIDRs: {len(all_cidrs)}")
          EOF

      - name: Compile merged-ip-direct.srs
        run: |
          sing-box rule-set compile \
            rule-set/merged-ip-direct.json \
            --output rule-set/merged-ip-direct.srs

      - name: Cleanup
        run: |
          rm -rf sources

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add rule-set/merged-ip-direct.json rule-set/merged-ip-direct.srs

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update merged-ip-direct rules"
            git push origin HEAD
          fi
