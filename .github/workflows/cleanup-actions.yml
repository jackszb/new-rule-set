name: Cleanup old GitHub Actions runs

on:
  schedule:
    - cron: "0 4 * * 0"   # 每周日 04:00
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Authenticate gh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth setup-git

      - name: Delete workflow runs older than 2 days
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CUTOFF_TS=$(date -u -d "2 days ago" +"%Y-%m-%dT%H:%M:%SZ")
          echo "Keeping workflow runs newer than: $CUTOFF_TS"

          for wf in $(gh api repos/$GH_REPO/actions/workflows --jq '.workflows[].id'); do
            echo "Processing workflow ID: $wf"

            gh api repos/$GH_REPO/actions/workflows/$wf/runs \
              --paginate \
              --jq '.workflow_runs[] | "\(.id) \(.created_at)"' |
            while read run_id created_at; do
              if [[ "$created_at" < "$CUTOFF_TS" ]]; then
                echo "Deleting run $run_id (created at $created_at)"
                gh api repos/$GH_REPO/actions/runs/$run_id -X DELETE
              fi
            done
          done
